<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zwl.dao.mapper.UserMapper" >
  <resultMap id="BaseResultMap" type="com.zwl.model.po.User" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="user_id" property="userId" jdbcType="VARCHAR" />
    <result column="wechat_openid" property="wechatOpenid" jdbcType="VARCHAR" />
    <result column="wechat_union_id" property="wechatUnionId" jdbcType="VARCHAR" />
    <result column="merchant_id" property="merchantId" jdbcType="VARCHAR" />
    <result column="register_from" property="registerFrom" />
    <result column="register_mobile" property="registerMobile" />
    <result column="real_name" property="realName" jdbcType="VARCHAR" />
    <result column="referrer" property="referrer" jdbcType="VARCHAR" />
    <result column="member_level" property="memberLevel" jdbcType="SMALLINT" />
    <result column="level_name" property="levelName" jdbcType="VARCHAR" />
    <result column="expires_time" property="expiresTime" jdbcType="TIMESTAMP" />
    <result column="register_time" property="registerTime" jdbcType="TIMESTAMP" />
    <result column="modify_time" property="modifyTime" jdbcType="TIMESTAMP" />
    <result column="available" property="available" jdbcType="INTEGER" />
  </resultMap>
  <sql id="Base_Column_List" >
    id, user_id, wechat_openid, wechat_union_id, merchant_id, register_from, register_mobile,real_name, referrer, member_level,
    level_name, expires_time, register_time, modify_time, available
  </sql>
  <sql id="Insert_Column_List" >
    user_id, wechat_openid, wechat_union_id, merchant_id, register_from, register_mobile,real_name, referrer, member_level,
    level_name, expires_time, register_time, modify_time, available
  </sql>
  <!--新增用户-->
  <insert id="insert" parameterType="com.zwl.model.po.User">
    <!--<selectKey keyProperty="userId" resultType="int" order="AFTER">
      select user_id from ss_user
    </selectKey>-->
    insert into ss_user (<include refid="Insert_Column_List"/>)
    values ( #{userId,jdbcType=VARCHAR}, #{wechatOpenid,jdbcType=VARCHAR}, #{wechatUnionId,jdbcType=VARCHAR},
    #{merchantId,jdbcType=VARCHAR}, #{registerFrom,jdbcType=SMALLINT}, #{registerMobile,jdbcType=VARCHAR},#{realName,jdbcType=VARCHAR}, #{referrer,jdbcType=VARCHAR}, #{memberLevel,jdbcType=SMALLINT},
    #{levelName,jdbcType=VARCHAR}, #{expiresTime,jdbcType=TIMESTAMP}, now(),
    #{modifyTime,jdbcType=TIMESTAMP}, #{available,jdbcType=INTEGER})
  </insert>
  <!--根据参数查找一个用户-->
  <select id="selectOneByParams" parameterType="com.zwl.model.po.User" resultMap="BaseResultMap">
    select
      <include refid="Base_Column_List"/>
    from
      ss_user
    <where>
      <if test="userId != null">
        user_id
      </if>
      <if test="wechatOpenid != null">
        AND wechat_openid=#{wechatOpenid,jdbcType=VARCHAR}
      </if>
      <if test="merchantId != null">
        AND merchant_id=#{merchantId,jdbcType=VARCHAR}
      </if>
     <!-- <if test="available != null">
        AND available=#{available,jdbcType=INTEGER}
      </if>-->
    </where>
  </select>

    <select id="getMemberLevel" resultType="int" parameterType="string">
        SELECT
            usr.member_level
        FROM
        ss_user usr
        WHERE
         datediff( usr.expires_time,now() ) >=0
        and user_id=#{userId}
        and available=1
    </select>
    <select id="getMaidPercentByUserId" resultType="int" parameterType="string">
      SELECT
            sp.maid_percent
        FROM
            ss_user usr,
            ss_product sp,
            ( SELECT referrer FROM ss_user WHERE user_id =#{userId}) t
        WHERE
            usr.user_id = t.referrer
            AND usr.member_level = sp.`level`
        and usr.available=1
    </select>

    <update id="updateUserById" parameterType="com.zwl.model.po.User">
        update ss_user
        <set>
            <if test="wechatOpenid != null">
                wechat_openid = #{wechatOpenid,jdbcType=VARCHAR},
            </if>
            <if test="wechatUnionId != null">
                wechat_union_id = #{wechatUnionId,jdbcType=VARCHAR},
            </if>
            <if test="merchantId != null">
                merchant_id = #{merchantId,jdbcType=VARCHAR},
            </if>
            <if test="referrer != null">
                referrer = #{referrer,jdbcType=VARCHAR},
            </if>
            <if test="memberLevel != null">
                member_level = #{memberLevel,jdbcType=SMALLINT},
            </if>
            <if test="levelName != null">
                level_name = #{levelName,jdbcType=VARCHAR},
            </if>
            <if test="expiresTime != null">
                expires_time = #{expiresTime,jdbcType=TIMESTAMP},
            </if>
            <if test="registerTime != null">
                register_time = #{registerTime,jdbcType=TIMESTAMP},
            </if>
            <if test="modifyTime != null">
                modify_time = #{modifyTime,jdbcType=TIMESTAMP},
            </if>
            <if test="available != null">
                available = #{available,jdbcType=INTEGER},
            </if>
        </set>
        where user_id = #{userId,jdbcType=VARCHAR}
    </update>

    <select id="getUserByUserId" resultMap="BaseResultMap" parameterType="string">
        select
        <include refid="Base_Column_List"/>
        from ss_user
        where available=1
        and user_id=#{userId}

    </select>
</mapper>